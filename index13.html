<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>サキガケ１頁小説</title>

<style>
body{
    background:#f5f5f5;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    margin:0;
}

.wrapper{
    display:flex;
    gap:40px;
    align-items:flex-start;
}

/* 左側コントロール */
.controls{
    display:flex;
    flex-direction:column;
}

textarea{
    width:300px;
    height:450px;
    font-size:15px;
}

textarea.over{
    color:red;
}

input{
    width:300px;
    margin-top:10px;
}

button{
    width:300px;
    margin-top:10px;
}

/* 文庫ページ */
.page{
    width:420px;
    height:600px;
    background:#f8f3e6;
    padding:20px;
    position:relative;
}

.watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 400px;
    height: 400px;
    background-image: url("logo.png");
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
    pointer-events: none;
    z-index: 0;
}

.header{
    height:40px;
    text-align:center;
    font-size:16px;
}

.inner{
    width:400px;
    height:500px;
    overflow:hidden;
    writing-mode:vertical-rl;
    font-size:15px;
    line-height:1.2;
    letter-spacing:1px;
    font-family:
        "Yu Mincho",
        "Hiragino Mincho ProN",
        "MS PMincho",
        serif;
}

.footer{
    position:absolute;
    bottom:20px;
    width:100%;
    text-align:center;
    font-size:12px;
}

ruby{
    ruby-position:over;
}
</style>
</head>

<body>

<div class="wrapper">

<div class="controls">
<textarea id="inputText"
placeholder="ここに小説を書いてください"></textarea>

<input type="text" id="titleInput"
placeholder="作品名">

<button id="rubyBtn">ルビ記法説明</button>

<button onclick="saveAsJPG()">JPG保存</button>
</div>

<div class="page">
<div class="watermark"></div>

<div class="header">
<span id="titleText">作品名</span>
</div>

<div class="inner">
<div id="novelText">ここに本文が表示されます。</div>
</div>

<div class="footer">
ペン先の欠片
</div>
</div>

</div>

<script>
const input = document.getElementById("inputText");
const output = document.getElementById("novelText");
const titleInput = document.getElementById("titleInput");
const titleText = document.getElementById("titleText");
const pageInner = document.querySelector(".inner");

/* ルビ変換 */
function convertRuby(text){
    return text.replace(/｜(.+?)《(.+?)》/g,
        "<ruby>$1<rt>$2</rt></ruby>");
}

/* 入力反映＋溢れ判定 */
input.addEventListener("input",()=>{
    let text = input.value;
    text = convertRuby(text);
    text = text.replace(/\n/g,"<br>");
    output.innerHTML = text;

    // ▼ 縦書きなので幅方向を見る
    if(pageInner.scrollWidth > pageInner.clientWidth){
        input.classList.add("over");
    }else{
        input.classList.remove("over");
    }
});

/* タイトル反映 */
titleInput.addEventListener("input",()=>{
    titleText.textContent = titleInput.value;
});

/* ルビ説明ボタン */
document.getElementById("rubyBtn").addEventListener("click",()=>{
    alert("ルビ記法：｜漢字《かんじ》");
});

/* ▼▼▼ ここから新しい JPG 保存処理（SVG 経由） ▼▼▼ */
function saveAsJPG() {
    const page = document.querySelector(".page");

    // 1. HTML を SVG に変換
    const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${page.offsetWidth}" height="${page.offsetHeight}">
        <foreignObject width="100%" height="100%">
            ${new XMLSerializer().serializeToString(page)}
        </foreignObject>
    </svg>`;

    const svgBlob = new Blob([svg], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(svgBlob);

    // 2. SVG → Canvas
    const img = new Image();
    img.onload = function () {
        const canvas = document.createElement("canvas");
        canvas.width = page.offsetWidth * 3;   // 高解像度
        canvas.height = page.offsetHeight * 3;
        const ctx = canvas.getContext("2d");

        ctx.scale(3, 3);
        ctx.drawImage(img, 0, 0);

        URL.revokeObjectURL(url);

        // 3. Canvas → JPG
        const link = document.createElement("a");
        link.download = "sakigake1p.jpg";
        link.href = canvas.toDataURL("image/jpeg", 0.98);
        link.click();
    };

    img.src = url;
}
/* ▲▲▲ 新しい JPG 保存処理ここまで ▲▲▲ */

</script>

</body>
</html>